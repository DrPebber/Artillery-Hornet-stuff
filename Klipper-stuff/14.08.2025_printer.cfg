# Artillery Hornet Klipper Config by EmmeFreeze
# Based on kiPHAW's config (https://www.youtube.com/watch?v=kokwZI83wzI)
# Thanks to: gpo 123 (display pinout)

####### FIRMWARE COMPILE OPTIONS ########

# Enable extra low-level configuration options: TRUE
# Micro-controller Architecture: STMicroelectronics STM32
# Processor model: STM32F401
# Bootloader offset: No bootloader
# Clock reference: 8 MHz crystal
# Communication interface: USB (on PA11/PA12)
# USB ids: DEFAULT
# GPIO pins to set at micro-controller startup: FALSE

# INPUT SHAPING ==================================================================

#[include macros/input_shaping.cfg]

# MCU ============================================================================

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f401xc_100035000D50435435373620-if00
restart_method: command
baud: 115200

# KINEMATICS =====================================================================

[printer]
kinematics: cartesian
max_velocity: 150
max_accel: 5000
max_z_velocity: 150
max_z_accel: 300
square_corner_velocity: 5 #Change to 5 for Input shaping 

# ================================================================================

[virtual_sdcard]
path: ~/printer_data/gcodes

# STEPPERS =======================================================================

[stepper_x]
step_pin: PB14
dir_pin: PB13
enable_pin: !PB15
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 40
endstop_pin: !PA2
position_min: 0
position_endstop: 220
position_max: 220
homing_speed: 100
homing_retract_dist: 5.0
homing_retract_speed: 30
second_homing_speed: 30

[stepper_y]
step_pin: PB10
dir_pin: PB2
enable_pin: !PB12
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 40
endstop_pin: !PA1
position_min: 0
position_endstop: 0
position_max: 235
homing_speed: 100
homing_retract_dist: 5.0
homing_retract_speed: 30
second_homing_speed: 30

[stepper_z]
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 8
endstop_pin: !PA0
position_min: -0.2
position_endstop: 0.0
position_max: 250
homing_speed: 30
homing_retract_dist: 5.0
homing_retract_speed: 15
second_homing_speed: 15

# EXTRUDER AND HOTEND =============================================================

[extruder]
max_extrude_only_distance: 200.0
max_extrude_cross_section: 50.0  # was 50.0
step_pin: PA7
dir_pin: PA6
enable_pin: !PC4
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 14.308
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC9
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC0

#control: pid  #Tuned for stock hardware with 200 degree Celsius target
#pid_Kp: 19.445
#pid_Ki: 0.781
#pid_Kd: 121.044

min_temp: 0
max_temp: 255
min_extrude_temp: 185
pressure_advance = 0.0
pressure_advance_smooth_time: 0.040

# BED ============================================================================

[bed_screws]  #Bed settings (bed leveling, pin)
screw1: 40, 40
screw2: 180, 40
screw3: 180, 180
screw4: 40, 180
screw5: 110, 110
speed: 100

[heater_bed] #Tuned for stock hardware with 50 degree Celsius target
heater_pin: PA8
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC1
min_temp: -5
max_temp: 130

control: pid
pid_Kp: 64.381
pid_Ki: 1.049
pid_Kd: 987.451

# BED LEVELING ===================================================================

[bltouch]
sensor_pin: ^PC2
control_pin: PC3
pin_move_time: 0.100
stow_on_each_sample: True
x_offset: -24
y_offset: -22
z_offset: 2
speed: 35
samples: 1
sample_retract_dist: 6.0

[bed_mesh]
speed: 200
horizontal_move_z: 5
mesh_min: 0, 0
mesh_max: 195,198
probe_count: 12
split_delta_z: .025
algorithm: bicubic    #lagrange - default for 3x3 mesh / bicubic
fade_start: 1
fade_end: 5
fade_target: 0
mesh_pps: 4, 4

# FANS ===========================================================================

[fan] #Fan settings (object, heater, controller fans)
pin: PC6
pin: PC8
kick_start_time: 0.550

[heater_fan hotend_fan]
pin: PC7
heater: extruder
heater_temp: 50.0
fan_speed: 0.8

[controller_fan stepper_fan]
pin: PC6
idle_timeout: 300
kick_start_time: 0.500

# DISPLAY ========================================================================

[display]
lcd_type: uc1701
cs_pin: PB6
a0_pin: PC15
rst_pin: PB5
contrast: 60
spi_bus:spi3a
encoder_pins: ^PB3,^PB4
click_pin: ^!PC14

[display_status]

[pause_resume]

# ================================================================================

#Enable Execute Object (beta) use https://github.com/troy-jacobson/klipper/tree/exclude-object-pr
[exclude_object]

[delayed_gcode my_delayed_gcode]
initial_duration: 1.0
gcode:
    BED_MESH_PROFILE LOAD="default1"

##### MACROS ####### =============================================================

#Basic macros
[include macros/basic.cfg]

#Homing macros
[include macros/home_axis.cfg]

#Mainsail
[include mainsail.cfg]

#Testing macros
[include macros/test_speed_and_accel.cfg]
